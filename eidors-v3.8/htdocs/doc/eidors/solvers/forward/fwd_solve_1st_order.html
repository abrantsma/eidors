<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of fwd_solve_1st_order</title>
  <meta name="keywords" content="fwd_solve_1st_order">
  <meta name="description" content="FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="../index.html">solvers</a> &gt; <a href="index.html">forward</a> &gt; fwd_solve_1st_order.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/solvers/forward&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>fwd_solve_1st_order
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function data =fwd_solve_1st_order(fwd_model, img) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)
 Fwd solver for Andy Adler's EIT code
 Input:
    img       = image struct
 Output:
    data = measurements struct
 Options: (to return internal FEM information)
    img.fwd_solve.get_all_meas = 1 (data.volt = all FEM nodes, but not CEM)
    img.fwd_solve.get_all_nodes= 1 (data.volt = all nodes, including CEM)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/algorithms/left_divide.html" class="code" title="function [V] = left_divide(E,I,tol,pp,V)">left_divide</a>	[V] = left_divide(E,I,tol,pp,V);</li><li><a href="../../../eidors/models/convert_img_units.html" class="code" title="function y = convert_img_units(img,arg1,arg2)">convert_img_units</a>	CONVERT_IMG_UNITS change image data units</li><li><a href="../../../eidors/models/data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>	DATA_MAPPER maps img.params data to elem or node data</li><li><a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../../eidors/models/mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="../../../eidors/models/supported_params.html" class="code" title="function list = supported_params">supported_params</a>	</li><li><a href="../../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>	SPARSE Create sparse matrix (EIDORS overload).</li><li><a href="../../../eidors/solvers/calc_system_mat.html" class="code" title="function system_mat = calc_system_mat( fwd_model, img)">calc_system_mat</a>	CALC_SYSTEM_MAT: calculate FEM system matrix from fwd_model and image</li><li><a href="fwd_model_parameters.html" class="code" title="function param = fwd_model_parameters( fwd_model )">fwd_model_parameters</a>	FWD_MODEL_PARAMETERS: data= fwd_solve_1st_order( fwd_model, image)</li><li><a href="fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>	FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)</li><li><a href="../../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>	EIDORS_CACHE Control eidors caching</li><li><a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/deprecated/aa_fwd_solve.html" class="code" title="function data =aa_fwd_solve(varargin)">aa_fwd_solve</a>	AA_FWD_SOLVE: data= aa_fwd_solve( fwd_model, img)</li><li><a href="../../../eidors/deprecated/np_fwd_solve.html" class="code" title="function data= np_fwd_solve( fwd_model, img)">np_fwd_solve</a>	NP_FWD_SOLVE: data= np_fwd_solve( fwd_model, img)</li><li><a href="../../../eidors/examples/demo_3d_simdata.html" class="code" title="">demo_3d_simdata</a>	How to make simulation data using EIDORS3D</li><li><a href="../../../eidors/examples/eidors2d_demo1.html" class="code" title="">eidors2d_demo1</a>	EidorsDemo1 Demonstrates the use of 2D EIT Package with linear basis</li><li><a href="../../../eidors/graphics/matlab/show_current.html" class="code" title="function quiv = show_current( img, vv )">show_current</a>	SHOW_CURRENT: show current or other quantity defined</li><li><a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>	FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)</li><li><a href="jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>	JACOBIAN_PERTURB: J= jacobian_perturb( fwd_model, img)</li><li><a href="system_mat_1st_order.html" class="code" title="function s_mat= system_mat_1st_order( fwd_model, img)">system_mat_1st_order</a>	SYSTEM_MAT_1ST_ORDER: SS= system_mat_1st_order( fwd_model, img)</li><li><a href="../../../eidors/tests/perturb_jacobian_test.html" class="code" title="">perturb_jacobian_test</a>	Perturbation Jacobians</li><li><a href="../../../eidors/tests/test_2d_resistor.html" class="code" title="function test_2d_resistor(opt)">test_2d_resistor</a>	Create 2D model of a cylindrical resistor</li><li><a href="../../../eidors/tests/test_3d_resistor.html" class="code" title="">test_3d_resistor</a>	Create 3D model of a Rectangular resistor</li><li><a href="../../../eidors/tests/test_c2f_jacobian.html" class="code" title="function test_c2f_jacobian">test_c2f_jacobian</a>	Test calc of jacobian given coarse to fine mapping</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function vv = meas_from_v_els( v_els, stim)</a></li><li><a href="#_sub2" class="code">function v2meas = get_v2meas(n_elec,n_stim,stim)</a></li><li><a href="#_sub3" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function data =fwd_solve_1st_order(fwd_model, img)</a>
0002 <span class="comment">% FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)</span>
0003 <span class="comment">% Fwd solver for Andy Adler's EIT code</span>
0004 <span class="comment">% Input:</span>
0005 <span class="comment">%    img       = image struct</span>
0006 <span class="comment">% Output:</span>
0007 <span class="comment">%    data = measurements struct</span>
0008 <span class="comment">% Options: (to return internal FEM information)</span>
0009 <span class="comment">%    img.fwd_solve.get_all_meas = 1 (data.volt = all FEM nodes, but not CEM)</span>
0010 <span class="comment">%    img.fwd_solve.get_all_nodes= 1 (data.volt = all nodes, including CEM)</span>
0011 
0012 <span class="comment">% (C) 1995-2002 Andy Adler. License: GPL version 2 or version 3</span>
0013 <span class="comment">% Ref: Adler &amp; Guardo (1996) IEEE T. Med Imaging</span>
0014 <span class="comment">% $Id: fwd_solve_1st_order.m 4928 2015-05-07 23:10:05Z aadler $</span>
0015 
0016 <span class="comment">% correct input paralemeters if function was called with only img</span>
0017 <span class="keyword">if</span> isstr(fwd_model) &amp;&amp; strcmp(fwd_model,<span class="string">'UNIT_TEST'</span>); <a href="#_sub3" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0018 
0019 <span class="keyword">if</span> nargin == 1
0020    img= fwd_model;
0021 <span class="keyword">elseif</span>  strcmp(getfield(warning(<span class="string">'query'</span>,<span class="string">'EIDORS:DeprecatedInterface'</span>),<span class="string">'state'</span>),<span class="string">'on'</span>)
0022    warning(<span class="string">'EIDORS:DeprecatedInterface'</span>, <span class="keyword">...</span>
0023       [<span class="string">'Calling FWD_SOLVE_1ST_ORDER with two arguments is deprecated and will cause'</span> <span class="keyword">...</span>
0024        <span class="string">' an error in a future version. First argument ignored.'</span>]);
0025 <span class="keyword">end</span>
0026 fwd_model= img.fwd_model;
0027 
0028 img = <a href="../../../eidors/models/data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img);
0029 <span class="keyword">if</span> ~ismember(img.current_params, <a href="../../../eidors/models/supported_params.html" class="code" title="function list = supported_params">supported_params</a>)
0030     error(<span class="string">'EIDORS:PhysicsNotSupported'</span>, <span class="string">'%s does not support %s'</span>, <span class="keyword">...</span>
0031     <span class="string">'FWD_SOLVE_1ST_ORDER'</span>,img.current_params);
0032 <span class="keyword">end</span>
0033 <span class="comment">% all calcs use conductivity</span>
0034 img = <a href="../../../eidors/models/convert_img_units.html" class="code" title="function y = convert_img_units(img,arg1,arg2)">convert_img_units</a>(img, <span class="string">'conductivity'</span>);
0035 
0036 pp= <a href="fwd_model_parameters.html" class="code" title="function param = fwd_model_parameters( fwd_model )">fwd_model_parameters</a>( fwd_model );
0037 s_mat= <a href="../../../eidors/solvers/calc_system_mat.html" class="code" title="function system_mat = calc_system_mat( fwd_model, img)">calc_system_mat</a>( img );
0038 
0039 idx= 1:size(s_mat.E,1);
0040 idx( fwd_model.gnd_node ) = [];
0041 
0042 v= zeros(pp.n_node,pp.n_stim);
0043 
0044 v(idx,:)= <a href="../../../eidors/algorithms/left_divide.html" class="code" title="function [V] = left_divide(E,I,tol,pp,V)">left_divide</a>( s_mat.E(idx,idx), pp.QQ(idx,:));
0045 
0046 <span class="comment">% calc voltage on electrodes</span>
0047 
0048 <span class="comment">% This is horribly inefficient, override</span>
0049 <span class="comment">% v_els= pp.N2E * v;</span>
0050 idx = find(any(pp.N2E));
0051 v_els= pp.N2E(:,idx) * v(idx,:);
0052 
0053 
0054 <span class="comment">% create a data structure to return</span>
0055 data.meas= <a href="#_sub1" class="code" title="subfunction vv = meas_from_v_els( v_els, stim)">meas_from_v_els</a>(v_els, fwd_model.stimulation);
0056 data.time= NaN; <span class="comment">% unknown</span>
0057 data.name= <span class="string">'solved by fwd_solve_1st_order'</span>;
0058 <span class="keyword">try</span>; <span class="keyword">if</span> img.fwd_solve.get_all_meas == 1
0059    data.volt = v(1:pp.n_node,:); <span class="comment">% but not on CEM nodes</span>
0060 <span class="keyword">end</span>; <span class="keyword">end</span>
0061 <span class="keyword">try</span>; <span class="keyword">if</span> img.fwd_solve.get_all_nodes== 1
0062    data.volt = v;                <span class="comment">% all, including CEM nodes</span>
0063 <span class="keyword">end</span>; <span class="keyword">end</span>
0064 
0065 <a name="_sub1" href="#_subfunctions" class="code">function vv = meas_from_v_els( v_els, stim)</a>
0066    <span class="keyword">try</span>
0067 <span class="comment">% Was 1.82s</span>
0068 <span class="comment">%        % measured voltages from v</span>
0069 <span class="comment">%    %   vv = zeros( pp.n_meas, 1 );</span>
0070 <span class="comment">%        idx=0;</span>
0071 <span class="comment">%        for i=1:length(stim)</span>
0072 <span class="comment">%           meas_pat= stim(i).meas_pattern;</span>
0073 <span class="comment">%           n_meas  = size(meas_pat,1);</span>
0074 <span class="comment">%           vv( idx+(1:n_meas) ) = meas_pat*v_els(:,i);</span>
0075 <span class="comment">%           idx= idx+ n_meas;</span>
0076 <span class="comment">%        end</span>
0077 
0078 <span class="comment">% This code replaced the previous - Nov 4, 2013</span>
0079 <span class="comment">% Now 0.437s</span>
0080 <span class="comment">% Why is it faster??</span>
0081 
0082        [n_elec,n_stim] = size(v_els);
0083 
0084        copt.cache_obj = {stim};
0085        copt.fstr = <span class="string">'v2meas'</span>;
0086        copt.log_level = 4;
0087        v2meas = <a href="../../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(@<a href="#_sub2" class="code" title="subfunction v2meas = get_v2meas(n_elec,n_stim,stim)">get_v2meas</a>, {n_elec,n_stim,stim}, copt);
0088        vv = v2meas' * v_els(:);
0089    <span class="keyword">catch</span> err
0090       <span class="keyword">if</span> strcmp(err.identifier, <span class="string">'MATLAB:innerdim'</span>);
0091           error([<span class="string">'measurement pattern not compatible with number'</span> <span class="keyword">...</span>
0092                   <span class="string">'of electrodes for stimulation patter %d'</span>],i);
0093       <span class="keyword">else</span>
0094           rethrow(err);
0095       <span class="keyword">end</span>
0096    <span class="keyword">end</span>
0097 
0098    
0099 <a name="_sub2" href="#_subfunctions" class="code">function v2meas = get_v2meas(n_elec,n_stim,stim)</a>
0100     v2meas = <a href="../../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(n_elec*n_stim,0);
0101     <span class="keyword">for</span> i=1:n_stim
0102         meas_pat= stim(i).meas_pattern;
0103         n_meas  = size(meas_pat,1);
0104         v2meas((i-1)*n_elec + 1: i*n_elec,end+(1:n_meas)) = meas_pat';
0105     <span class="keyword">end</span>
0106         
0107 
0108 <a name="_sub3" href="#_subfunctions" class="code">function do_unit_test</a>
0109    img = <a href="../../../eidors/models/mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>( <a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'b2c2'</span>,16),1);
0110    vh = <a href="fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>(img);
0111 plot(vh.meas);
0112    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'b2c2 TEST'</span>, vh.meas(1:5), <span class="keyword">...</span>
0113   [ 0.959567140078593; 0.422175237237900; 0.252450963869202; <span class="keyword">...</span>
0114     0.180376116490602; 0.143799778367518], 1e-8);
0115    img.fwd_solve.get_all_meas = 1;
0116    vh = <a href="fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>(img);
0117 plot(vh.volt);</pre></div>
<hr><address>Generated on Tue 12-May-2015 16:08:56 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>