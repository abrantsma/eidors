<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of mk_tri_c2f</title>
  <meta name="keywords" content="mk_tri_c2f">
  <meta name="description" content="MK_TRI_C2F">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">eidors</a> &gt; <a href="index.html">models</a> &gt; mk_tri_c2f.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/models&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>mk_tri_c2f
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>MK_TRI_C2F</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function c2f = mk_tri_c2f(fmdl,rmdl,opt) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">MK_TRI_C2F</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="find_edge2edge_intersections.html" class="code" title="function [pts,FE2CE,FE2pts,CE2pts] = find_edge2edge_intersections(FE,FN,CE,CN, epsilon)">find_edge2edge_intersections</a>	FIND_EDGE2EDGE_INTERSECTIONS intersections between edges of two models</li><li><a href="fix_model.html" class="code" title="function [mdl] = fix_model(mdl,opt)">fix_model</a>	FIX_MODEL: Add useful fields to a model</li><li><a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>	GET_ELEM_VOLUME: VOL = get_elem_volume(fwd_model, map_node )</li><li><a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="mk_tri_c2f.html" class="code" title="function c2f = mk_tri_c2f(fmdl,rmdl,opt)">mk_tri_c2f</a>	MK_TRI_C2F</li><li><a href="point_in_triangle.html" class="code" title="function out = point_in_triangle(P,E,V,epsilon, str)">point_in_triangle</a>	POINT_IN_TRIANGLE tests points for membership in triangles</li><li><a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>	SPARSE Create sparse matrix (EIDORS overload).</li><li><a href="../../eidors/overloads/uniquetol.html" class="code" title="function out = uniquetol(in, tol, varargin)">uniquetol</a>	C = uniquetol(A,TOL):  unique values in A using tolerance TOL.</li><li><a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>	EIDORS_CACHE Control eidors caching</li><li><a href="../../eidors/tools/eidors_debug.html" class="code" title="function out = eidors_debug(command, fstr)">eidors_debug</a>	EIDORS_DEBUG Global managment of debug flags</li><li><a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>	PROGRESS_MSG Progress messages and timing.</li><li><a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="mk_tri_c2f.html" class="code" title="function c2f = mk_tri_c2f(fmdl,rmdl,opt)">mk_tri_c2f</a>	MK_TRI_C2F</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function c2f = do_mk_tri_c2f(fmdl,rmdl,opt)</a></li><li><a href="#_sub2" class="code">function [pts,FE2CE,FE2pts,CE2pts] = find_edge2edge_intersections(FE,FN,CE,CN, epsilon)</a></li><li><a href="#_sub3" class="code">function fmdl = prepare_tri_mdl(fmdl)</a></li><li><a href="#_sub4" class="code">function [fmdl,rmdl,fmdl_idx,rmdl_idx] = crop_models(fmdl,rmdl)</a></li><li><a href="#_sub5" class="code">function[fmdl,rmdl] = center_scale_models(fmdl,rmdl, opt)</a></li><li><a href="#_sub6" class="code">function opt = parse_opts(fmdl,rmdl, opt)</a></li><li><a href="#_sub7" class="code">function do_unit_test</a></li><li><a href="#_sub8" class="code">function do_small_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function c2f = mk_tri_c2f(fmdl,rmdl,opt)</a>
0002 <span class="comment">%MK_TRI_C2F</span>
0003 
0004 <span class="comment">% (C) 2015 Bartlomiej Grychtol - all rights reserved by Swisstom AG</span>
0005 <span class="comment">% License: GPL version 2 or 3</span>
0006 <span class="comment">% $Id: mk_tri_c2f.m 4982 2015-05-11 18:52:56Z bgrychtol $</span>
0007 
0008 <span class="comment">% &gt;&gt; SWISSTOM CONTRIBUTION &lt;&lt;</span>
0009 
0010 <span class="keyword">if</span> ischar(fmdl) &amp;&amp; strcmp(fmdl,<span class="string">'UNIT_TEST'</span>), <a href="#_sub7" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0011 <span class="keyword">if</span> nargin &lt; 3
0012    opt = struct();
0013 <span class="keyword">end</span>
0014 
0015 f_elems = size(fmdl.elems,1);
0016 r_elems = size(rmdl.elems,1);
0017 
0018 c2f = <a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(f_elems,r_elems);
0019 [fmdl,rmdl,fmdl_idx,rmdl_idx] = <a href="#_sub4" class="code" title="subfunction [fmdl,rmdl,fmdl_idx,rmdl_idx] = crop_models(fmdl,rmdl)">crop_models</a>(fmdl,rmdl);
0020 
0021 <span class="keyword">if</span> ~(any(fmdl_idx) &amp;&amp; any(rmdl_idx))
0022    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@: models do not overlap, returning all-zeros'</span>);
0023    <span class="keyword">return</span>
0024 <span class="keyword">end</span>
0025 
0026 [fmdl,rmdl] = <a href="#_sub5" class="code" title="subfunction[fmdl,rmdl] = center_scale_models(fmdl,rmdl, opt)">center_scale_models</a>(fmdl,rmdl, opt);
0027 
0028 opt = <a href="#_sub6" class="code" title="subfunction opt = parse_opts(fmdl,rmdl, opt)">parse_opts</a>(fmdl,rmdl, opt);
0029 
0030 
0031 copt.fstr = <span class="string">'mk_tri_c2f'</span>;
0032 
0033 c2f(fmdl_idx,rmdl_idx) = <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(@<a href="#_sub1" class="code" title="subfunction c2f = do_mk_tri_c2f(fmdl,rmdl,opt)">do_mk_tri_c2f</a>,{fmdl,rmdl,opt},copt);
0034 <span class="keyword">end</span>
0035 
0036 <a name="_sub1" href="#_subfunctions" class="code">function c2f = do_mk_tri_c2f(fmdl,rmdl,opt)</a>
0037    DEBUG = <a href="../../eidors/tools/eidors_debug.html" class="code" title="function out = eidors_debug(command, fstr)">eidors_debug</a>(<span class="string">'query'</span>,<span class="string">'mk_tri_c2f'</span>);
0038    
0039    c2f = <a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(0,0);
0040    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Prepare fine model...'</span>);
0041    fmdl = <a href="#_sub3" class="code" title="subfunction fmdl = prepare_tri_mdl(fmdl)">prepare_tri_mdl</a>(fmdl);
0042    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(Inf);
0043    
0044    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Prepare course model...'</span>);
0045    rmdl = <a href="#_sub3" class="code" title="subfunction fmdl = prepare_tri_mdl(fmdl)">prepare_tri_mdl</a>(rmdl);
0046    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(Inf);
0047    
0048    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find edge2edge intersections...'</span>);
0049    [intpts,fedge2redge,fedge2intpts,redge2intpts] = <span class="keyword">...</span>
0050       <a href="find_edge2edge_intersections.html" class="code" title="function [pts,FE2CE,FE2pts,CE2pts] = find_edge2edge_intersections(FE,FN,CE,CN, epsilon)">find_edge2edge_intersections</a>( fmdl.edges,fmdl.nodes,<span class="keyword">...</span>
0051                                     rmdl.edges,rmdl.nodes, opt.tol_edge2edge);
0052    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>,size(intpts,1)),Inf);
0053 
0054    
0055    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find c_nodes in f_elems...'</span>);
0056    rnode2ftri = <a href="point_in_triangle.html" class="code" title="function out = point_in_triangle(P,E,V,epsilon, str)">point_in_triangle</a>(rmdl.nodes, fmdl.elems, fmdl.nodes, opt.tol_node2tri);
0057    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, nnz(rnode2ftri)), Inf);
0058    
0059    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find c_elems in f_elems...'</span>)
0060    rtri_in_ftri = (double(rmdl.node2elem') * rnode2ftri) == 3;
0061    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>,nnz(rtri_in_ftri)), Inf);
0062    
0063    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find f_nodes in c_elems...'</span>);
0064    fnode2rtri = <a href="point_in_triangle.html" class="code" title="function out = point_in_triangle(P,E,V,epsilon, str)">point_in_triangle</a>(fmdl.nodes, rmdl.elems, rmdl.nodes, opt.tol_node2tri);
0065    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, nnz(fnode2rtri)), Inf);
0066    
0067    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find f_elems in c_elems...'</span>)
0068    ftri_in_rtri = (double(fmdl.node2elem') * fnode2rtri) == 3;
0069    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>,nnz(ftri_in_rtri)), Inf);
0070 
0071    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find total intersections...'</span>);
0072    rtri2ftri = double(rmdl.edge2elem') * fedge2redge' * fmdl.edge2elem;
0073    <span class="comment">% exclude inclusion (dealt with separately)</span>
0074    rtri2ftri = rtri2ftri &amp; ~rtri_in_ftri &amp; ~ftri_in_rtri'; 
0075    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>,nnz(rtri2ftri)), Inf);
0076    
0077    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Calculate intersection volumes...'</span>);
0078    <span class="comment">% sparse logical multiplication doesn't exist</span>
0079    rtri2intpt = logical(rmdl.edge2elem'*redge2intpts)';
0080    ftri2intpt = logical(fmdl.edge2elem'*fedge2intpts)';
0081    
0082    rtri_todo = find(sum(rtri2ftri,2)&gt;0);
0083    C = []; F = []; V = [];
0084 
0085    id = 0; N = length(rtri_todo);
0086    mint = ceil(N/100);
0087    <span class="keyword">for</span> v = rtri_todo'
0088       id = id+1;
0089       <span class="keyword">if</span> mod(id,mint)==0, <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(id/N); <span class="keyword">end</span>
0090       tri_todo = find(rtri2ftri(v,:));
0091 
0092       common_intpts = bsxfun(@and,rtri2intpt(:,v), ftri2intpt(:,tri_todo));
0093       
0094       f_nodes     = bsxfun(@and,fnode2rtri(:,v), fmdl.node2elem(:,tri_todo));
0095       r_nodes     = bsxfun(@and,rnode2ftri(:,tri_todo), rmdl.node2elem(:,v));
0096       
0097       C = [C; v*ones(numel(tri_todo),1)];
0098       F = [F; tri_todo'];
0099       last_v = numel(V);
0100       V = [V; zeros(numel(tri_todo),1)]; <span class="comment">% pre-allocate</span>
0101       
0102       <span class="keyword">for</span> t = 1:numel(tri_todo)
0103          pts = [ intpts(common_intpts(:,t),:);
0104                   fmdl.nodes(f_nodes(:,t),:);
0105                   rmdl.nodes(r_nodes(:,t),:)];
0106          last_v = last_v + 1;
0107          <span class="keyword">if</span> size(pts,1) &lt; 3, <span class="keyword">continue</span>, <span class="keyword">end</span> 
0108          <span class="keyword">try</span>
0109             <span class="comment">% move points to origin (helps for small elements at</span>
0110             <span class="comment">% large coordinates</span>
0111             ctr = mean(pts);
0112             pts = bsxfun(@minus,pts,ctr);
0113             scale = max(abs(pts(:)));
0114             <span class="keyword">if</span> scale == 0 <span class="comment">%happens when there's only one point</span>
0115                <span class="keyword">continue</span>
0116             <span class="keyword">end</span>
0117             <span class="comment">% scale largest coordinate to 1 (helps with precision)</span>
0118             pts = pts ./ scale;
0119             <span class="comment">% force thorough search for initinal simplex and</span>
0120             <span class="comment">% supress precision warnings</span>
0121             [K, V(last_v)] = convhulln(pts,{<span class="string">'Qt Pp Qs'</span>});
0122             V(last_v) = max(V(last_v),0); <span class="comment">% numerical issues may produce tiny negative volume</span>
0123             V(last_v) = V(last_v) * scale^2; <span class="comment">% undo scaling</span>
0124          <span class="keyword">catch</span> err
0125             ok = false;
0126             <span class="keyword">switch</span> err.identifier
0127                <span class="keyword">case</span> {<span class="string">'MATLAB:qhullmx:DegenerateData'</span>, <span class="string">'MATLAB:qhullmx:UndefinedError'</span>}
0128                   <span class="comment">% border case point may be included multiple times.</span>
0129                   <span class="comment">% this is OK... though we may miss cases where more</span>
0130                   <span class="comment">% points should have been found but were not</span>
0131                   u = <a href="../../eidors/overloads/uniquetol.html" class="code" title="function out = uniquetol(in, tol, varargin)">uniquetol</a>(pts*scale,eps,<span class="string">'ByRows'</span>,true,<span class="string">'DataScale'</span>, 1);
0132                   ok = ok | (size(u,1) &lt; 3);
0133                   <span class="keyword">if</span> ~ok
0134                      <span class="comment">% test for colinearity</span>
0135                      cp = bsxfun(@minus, u(2:<span class="keyword">end</span>,:), u(1,:));
0136                      l = sqrt(sum(cp.^2,2));
0137                      cp = bsxfun(@rdivide, cp, l);
0138                      u = <a href="../../eidors/overloads/uniquetol.html" class="code" title="function out = uniquetol(in, tol, varargin)">uniquetol</a>(cp,eps,<span class="string">'ByRows'</span>,true,<span class="string">'DataScale'</span>,1);
0139                      ok = ok | size(u,1) == 1; <span class="comment">% co-linear points</span>
0140                   <span class="keyword">end</span>
0141             <span class="keyword">end</span>
0142             <span class="keyword">if</span> ~ok
0143                <span class="keyword">if</span> DEBUG || <a href="../../eidors/tools/eidors_debug.html" class="code" title="function out = eidors_debug(command, fstr)">eidors_debug</a>(<span class="string">'query'</span>,<span class="string">'mk_tet_c2f:convhulln'</span>);
0144                   tri.nodes = fmdl.nodes;
0145                   vox.nodes = rmdl.nodes;
0146                   tri.type = <span class="string">'fwd_model'</span>;
0147                   vox.type = <span class="string">'fwd_model'</span>;
0148                   vox.elems = rmdl.elems(v,:);
0149                   vox.boundary = vox.elems;
0150                   tri.elems = fmdl.elems(tri_todo(t),:);
0151                   clf
0152                   <a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(vox)
0153                   hold on
0154                   h = <a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(tri);
0155                   set(h,<span class="string">'EdgeColor'</span>,<span class="string">'b'</span>)
0156                   pts = bsxfun(@plus,pts*scale,ctr);
0157                   plot(pts(:,1),pts(:,2),<span class="string">'o'</span>);
0158                   hold off
0159                   axis auto
0160                   keyboard
0161                <span class="keyword">else</span>
0162                   fprintf(<span class="string">'\n'</span>);
0163                   <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>([<span class="string">'convhulln has thrown an error. '</span> <span class="keyword">...</span>
0164                      <span class="string">'Enable eidors_debug on mk_tri_c2f and re-run to see a debug plot'</span>],0);
0165                   rethrow(err);
0166                <span class="keyword">end</span>
0167             <span class="keyword">end</span>
0168          <span class="keyword">end</span>
0169          
0170       <span class="keyword">end</span>
0171    <span class="keyword">end</span>
0172    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(Inf);
0173    
0174    c2f = <a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(F,C,V,size(fmdl.elems,1),size(rmdl.elems,1));
0175    
0176    <span class="comment">% add rtri contained in ftri</span>
0177    <span class="keyword">try</span> rmdl = rmfield(rmdl,<span class="string">'coarse2fine'</span>); <span class="keyword">end</span> <span class="comment">% messes with volume</span>
0178    c2f = c2f + bsxfun(@times, <a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(rtri_in_ftri), <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(rmdl))';
0179    
0180    <span class="comment">% normalize to fine volume</span>
0181    vol = <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(fmdl);
0182    c2f = bsxfun(@rdivide,c2f,vol);
0183    
0184    <span class="comment">% add fine elems contained in coarse elems</span>
0185    c2f = c2f + ftri_in_rtri;
0186 
0187 <span class="keyword">end</span>
0188 
0189 
0190 <a name="_sub2" href="#_subfunctions" class="code">function [pts,FE2CE,FE2pts,CE2pts] = find_edge2edge_intersections(FE,FN,CE,CN, epsilon)</a>
0191    P1 = FN(FE(:,1),:);
0192    P2 = FN(FE(:,2),:);
0193    P3 = CN(CE(:,1),:);
0194    P4 = CN(CE(:,2),:);
0195    
0196    P21 = P2 - P1;
0197    P43 = P4 - P3;
0198    
0199    invden = ( bsxfun(@times, P21(:,1), P43(:,2)') - <span class="keyword">...</span>
0200               bsxfun(@times, P21(:,2), P43(:,1)')       ).^-1;
0201    P13_x = bsxfun(@minus,P1(:,1),P3(:,1)');
0202    P13_y = bsxfun(@minus,P1(:,2),P3(:,2)');
0203    s = ( bsxfun(@times,-P21(:,2), P13_x) + <span class="keyword">...</span>
0204          bsxfun(@times, P21(:,1), P13_y)) .* invden;
0205    t = ( bsxfun(@times,-P43(:,2)',P13_x) + <span class="keyword">...</span>
0206          bsxfun(@times, P43(:,1)',P13_y)) .* invden;
0207 
0208    FE2CE= s &gt;= 0 &amp; s &lt;= 1 &amp; t &gt;= 0 &amp; t &lt;= 1;
0209    
0210    [fe, ce] = find(FE2CE);
0211    N_pts = size(fe,1);
0212    pts = zeros(N_pts,2);
0213    <span class="keyword">for</span> i = 1:N_pts
0214       pts(i,:) = P1(fe(i),:) + t(fe(i),ce(i)) * P21(fe(i),:);
0215    <span class="keyword">end</span>
0216    FE2CE = <a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(FE2CE);
0217    N_ce = size(CE,1);
0218    N_fe = size(FE,1);
0219    FE2pts = <a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(fe, 1:N_pts, ones(N_pts,1), N_fe, N_pts);
0220    CE2pts = <a href="../../eidors/overloads/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(ce, 1:N_pts, ones(N_pts,1), N_ce, N_pts);
0221 
0222 
0223 <span class="keyword">end</span>
0224 
0225 <span class="comment">%-------------------------------------------------------------------------%</span>
0226 <span class="comment">% Prepare model</span>
0227 <a name="_sub3" href="#_subfunctions" class="code">function fmdl = prepare_tri_mdl(fmdl)</a>
0228    fmopt.elem2edge = true;
0229    fmopt.edge2elem = true;
0230 <span class="comment">%    fmopt.face2elem = true;</span>
0231    fmopt.node2elem = true;
0232 <span class="comment">%    fmopt.normals   = true;</span>
0233    fmopt.linear_reorder = false; <span class="comment">% this is slow and not needed</span>
0234    ll = <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>,1);
0235    fmdl = <a href="fix_model.html" class="code" title="function [mdl] = fix_model(mdl,opt)">fix_model</a>(fmdl,fmopt);
0236    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>,ll);
0237    fmdl.node2elem = logical(fmdl.node2elem);
0238 
0239 <span class="keyword">end</span>
0240 
0241 <span class="comment">%-------------------------------------------------------------------------%</span>
0242 <span class="comment">% Remove obviously non-overlapping parts of the models</span>
0243 <a name="_sub4" href="#_subfunctions" class="code">function [fmdl,rmdl,fmdl_idx,rmdl_idx] = crop_models(fmdl,rmdl)</a>
0244 
0245 <span class="comment">% instead of the usual approach, we could calculate the convex hull and</span>
0246 <span class="comment">% then use inpolygon... but that would require trusting inpolygon</span>
0247 
0248    f_min = min(fmdl.nodes);
0249    f_max = max(fmdl.nodes);
0250    r_min = min(rmdl.nodes);
0251    r_max = max(rmdl.nodes);
0252    
0253    <span class="comment">% nodes outside the bounding box of the other model</span>
0254    f_gt  = bsxfun(@gt, fmdl.nodes, r_max);
0255    f_lt  = bsxfun(@lt, fmdl.nodes, r_min);
0256    r_gt  = bsxfun(@gt, rmdl.nodes, f_max);
0257    r_lt  = bsxfun(@lt, rmdl.nodes, f_min);
0258 
0259    <span class="comment">% elems outside the bounding box of the other model</span>
0260    re_gt = any(reshape(all(reshape(r_gt(rmdl.elems',:),3,[])),[],2),2);
0261    re_lt = any(reshape(all(reshape(r_lt(rmdl.elems',:),3,[])),[],2),2);
0262    fe_gt = any(reshape(all(reshape(f_gt(fmdl.elems',:),3,[])),[],2),2);
0263    fe_lt = any(reshape(all(reshape(f_lt(fmdl.elems',:),3,[])),[],2),2);
0264    
0265    <span class="comment">% elems to keep</span>
0266    rmdl_idx = ~(re_gt | re_lt);
0267    fmdl_idx = ~(fe_gt | fe_lt);
0268    
0269    <span class="comment">% remove non-overlapping elems</span>
0270    rmdl.elems = rmdl.elems(rmdl_idx,:);
0271    fmdl.elems = fmdl.elems(fmdl_idx,:);
0272    
0273    <span class="comment">% remove unused nodes</span>
0274    [r_used_nodes,jnk,r_n] = unique(rmdl.elems(:));
0275    [f_used_nodes,jnk,f_n] = unique(fmdl.elems(:));
0276    
0277    r_idx = 1:numel(r_used_nodes);
0278    f_idx = 1:numel(f_used_nodes);
0279    
0280    rmdl.elems = reshape(r_idx(r_n),[],3);
0281    fmdl.elems = reshape(f_idx(f_n),[],3);
0282    
0283    rmdl.nodes = rmdl.nodes(r_used_nodes,:);
0284    fmdl.nodes = fmdl.nodes(f_used_nodes,:);
0285    
0286    <span class="comment">% for the benefit of any (debug) plots later on</span>
0287    rmdl = rmfield(rmdl,<span class="string">'boundary'</span>);
0288    fmdl = rmfield(fmdl,<span class="string">'boundary'</span>);
0289     
0290 <span class="keyword">end</span>
0291 
0292 <span class="comment">%-------------------------------------------------------------------------%</span>
0293 <span class="comment">% Center scale models</span>
0294 <a name="_sub5" href="#_subfunctions" class="code">function[fmdl,rmdl] = center_scale_models(fmdl,rmdl, opt)</a>
0295    ctr = mean([min(rmdl.nodes);max(rmdl.nodes)]);
0296    rmdl.nodes = bsxfun(@minus,rmdl.nodes,ctr);
0297    fmdl.nodes = bsxfun(@minus,fmdl.nodes,ctr);
0298    <span class="keyword">if</span> isfield(opt,<span class="string">'do_not_scale'</span>) &amp;&amp; opt.do_not_scale
0299       <span class="keyword">return</span>
0300    <span class="keyword">end</span>
0301    maxnode = min( max(abs(rmdl.nodes(:))), max(abs(fmdl.nodes(:))));
0302    scale = 1/maxnode;
0303    rmdl.nodes = scale*rmdl.nodes;
0304    fmdl.nodes = scale*fmdl.nodes;
0305    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@ models scaled by %g'</span>, scale,2);
0306 <span class="keyword">end</span>
0307 
0308 <span class="comment">%-------------------------------------------------------------------------%</span>
0309 <span class="comment">% Parse option struct</span>
0310  <a name="_sub6" href="#_subfunctions" class="code">function opt = parse_opts(fmdl,rmdl, opt)</a>
0311 
0312     
0313     <span class="keyword">if</span> ~isfield(opt, <span class="string">'tol_node2tri'</span>);
0314         opt.tol_node2tri = eps; <span class="comment">% * max(rmdl_rng,fmdl_rng)^3;</span>
0315     <span class="keyword">end</span>
0316     <span class="keyword">if</span> ~isfield(opt, <span class="string">'tol_edge2edge'</span>)
0317         opt.tol_edge2edge = 2*sqrt(3)*eps(min(max(abs(fmdl.nodes(:))),max(abs(rmdl.nodes(:)))));
0318     <span class="keyword">end</span>
0319 <span class="comment">%     if ~isfield(opt, 'tol_node2tri')</span>
0320 <span class="comment">%         opt.tol_edge2tri = eps; %1e-10</span>
0321 <span class="comment">%     end</span>
0322 <span class="comment">%     if ~isfield(opt, 'save_memory')</span>
0323 <span class="comment">%        opt.save_memory = 0;</span>
0324 <span class="comment">%     end</span>
0325     <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@ node2tri  tolerance = %g'</span>, opt.tol_node2tri,2);
0326     <a href="../../eidors/eidors_msg.html" class="code" title="function log_level= eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@ edge2edge tolerance = %g'</span>, opt.tol_edge2edge,2);
0327 <span class="comment">%     eidors_msg('@@ edge2tri  tolerance = %g', opt.tol_edge2tri,2);</span>
0328  <span class="keyword">end</span>   
0329 
0330 <a name="_sub7" href="#_subfunctions" class="code">function do_unit_test</a>
0331    <a href="#_sub8" class="code" title="subfunction do_small_test">do_small_test</a>
0332 <span class="keyword">end</span>
0333 
0334 <a name="_sub8" href="#_subfunctions" class="code">function do_small_test</a>
0335    imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c'</span>,16);
0336    rmdl = imdl.fwd_model;
0337 <span class="comment">%    rmdl = ng_mk_cyl_models([0 .5],[],[]);</span>
0338 <span class="comment">%    rmdl.nodes(:,1) = rmdl.nodes(:,1) + .5;</span>
0339 <span class="comment">%    show_fem(rmdl,[0 0 1])</span>
0340 <span class="comment">%    hold all</span>
0341    imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'d2c'</span>,16);
0342    fmdl = imdl.fwd_model;
0343 <span class="comment">%    fmdl = ng_mk_cyl_models([0 .5 .1],[],[]);</span>
0344 <span class="comment">%    h = show_fem(fmdl);</span>
0345 <span class="comment">%    set(h,'edgecolor','b','facecolor','none');</span>
0346 <span class="comment">%    hold off</span>
0347 <span class="comment">%    axis auto</span>
0348    c2f = <a href="mk_tri_c2f.html" class="code" title="function c2f = mk_tri_c2f(fmdl,rmdl,opt)">mk_tri_c2f</a>(fmdl,rmdl);
0349    
0350    
0351    clf
0352    img1 = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(fmdl,0);
0353    img1.elem_data = sum(c2f,2);
0354    img1.calc_colous.ref_level = .5;
0355    img1.calc_colours.clim = .5;
0356    
0357    subplot(121)
0358    <a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img1);
0359    img2 = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(rmdl,0);
0360    img2.elem_data = (c2f' * <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(fmdl)) ./ <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(rmdl);
0361    img2.calc_colous.ref_level = .5;
0362    img2.calc_colours.clim = .55;
0363    subplot(122)
0364    <a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img2);
0365    
0366    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Check C2F size'</span>, size(c2f),[length(fmdl.elems), length(rmdl.elems)]);
0367    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Check C2F max==1'</span>, max(c2f(:)), 1);
0368    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Check C2F min==0'</span>, min(c2f(:)), 0);
0369    
0370    f2c = bsxfun(@rdivide, bsxfun(@times, c2f, <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(fmdl))', <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(rmdl));
0371    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Check F2C max==1'</span>, max(sum(f2c,2)), 1, 1e-15);
0372    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Check F2C min==0'</span>, min(f2c(:)), 0);
0373 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 12-May-2015 16:08:56 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>